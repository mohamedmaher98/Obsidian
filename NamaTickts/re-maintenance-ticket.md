# تيكت: إضافة منظومة الصيانة العقارية - موديول العقارات

## نظرة عامة

المطلوب إضافة 3 كيانات جديدة في موديول العقارات لإدارة صندوق الصيانة العقاري، وتشمل:

1. **صندوق الصيانة العقاري** (REMaintenanceFund) - ملف رئيسي Master File
2. **أرباح صندوق وديعة الصيانة** (REMaintenanceDepositProfit) - مستند Document
3. **إثبات استحقاق الصيانة** (REMaintenanceAccrual) - مستند Document بتفاصيل

بالإضافة لتعديل على كيان **الوحدة العقارية** (RERentalUnit) بإضافة حقل checkbox "تخضع للصيانة".

---

## الفكرة العامة (Business Context)

في المشاريع العقارية، لما بيتم بيع وحدات سكنية أو تجارية، بيكون في جزء من العقد اسمه "وديعة الصيانة" - دي مبلغ بيدفعه المشتري عشان يغطي تكاليف صيانة المشروع (مصاعد، حدائق، أمن، نظافة، إلخ).

**صندوق الصيانة** هو اللي بيجمع كل ودائع الصيانة دي في مكان واحد لكل مشروع، وبيتتبع المحصل والمتبقي.

**أرباح الوديعة** - لما الصندوق بيكون فيه فلوس متجمعة في البنك، ممكن تحقق أرباح (فوائد بنكية مثلاً)، فبنسجل الأرباح دي ونعمل قيد محاسبي بيها.

**إثبات استحقاق الصيانة** - في آخر كل سنة (أو حسب الحاجة) بنحسب تكلفة الصيانة الفعلية لكل وحدة. ممكن يكون الحساب بناءً على:
- **صيانة السنة**: تكلفة الصيانة السنوية مقسومة على المساحة الإجمالية × مساحة كل وحدة
- **فروقات صيانة مدينة/دائنة**: الفرق بين المصروف الفعلي والمحصل من الملاك

---

## 1. صندوق الصيانة العقاري (REMaintenanceFund)

### الوصف
ملف رئيسي (Master File) يمثل صندوق الصيانة الخاص بكل مشروع عقاري. يجمع بيانات الصندوق ويعرض ملخص الوحدات المرتبطة.

### الحقول المطلوبة

| #   | الحقل                     | Field ID                        | النوع            | الوصف                                                  |
| --- | ------------------------- | ------------------------------- | ---------------- | ------------------------------------------------------ |
| 1   | كود                       | code                            | String           | كود الصندوق (موجود من MasterFile)                      |
| 2   | اسم                       | name                            | String           | اسم الصندوق (موجود من MasterFile)                      |
| 3   | المشروع                   | project                         | FK → REProject   | المشروع العقاري المرتبط                                |
| 4   | إجمالي قيمة وديعة الصيانة | totalMaintenanceDepositAmount   | Decimal          | إجمالي قيم تكاليف الصيانة لوحدات المشروع من عقود البيع |
| 5   | إجمالي المحصّل            | totalCollectedMaintenanceAmount | Decimal          | القيم المحصلة فعلياً من أقساط الصيانة                  |
| 6   | البنك                     | bank                            | FK → Bank        | البنك المودع فيه أموال الصندوق                         |
| 7   | الحساب البنكي             | bankAccount                     | FK → BankAccount | الحساب البنكي المحدد                                   |
| 8   | إجمالي مساحة المشروع      | totalProjectArea                | Decimal          | مجموع مساحات وحدات المشروع                             |
| 9   | الرصيد المتبقي            | remainingBalance                | Decimal          | محسوب = إجمالي الوديعة - إجمالي المحصل                 |

### List View (جدول الوحدات)

الصندوق يحتوي على عرض قائمة (List View) يعرض الوحدات المرتبطة بالمشروع والمنتمية للصندوق:

| #   | العمود            | الوصف                                   |
| --- | ----------------- | --------------------------------------- |
| 1   | الوحدة            | اسم/كود الوحدة العقارية                 |
| 2   | قيمة صيانة الوحدة | قيمة وديعة الصيانة المحددة في عقد البيع |
| 3   | مساحة الوحدة      | مساحة الوحدة بالمتر المربع              |
| 4   | اسم المشتري       | المشتري المرتبط بالوحدة من عقد البيع    |

### ملاحظات البيزنس
- حقل "إجمالي قيمة وديعة الصيانة" يتم حسابه من مجموع قيم تكلفة الصيانة في عقود بيع وحدات المشروع المختار
- حقل "إجمالي المحصل" يتم حسابه من الأقساط المحصلة فعلياً
- حقل "إجمالي مساحة المشروع" = مجموع مساحات الوحدات في المشروع
- الرصيد المتبقي = إجمالي الوديعة - إجمالي المحصل

---

### Checklist - صندوق الصيانة العقاري

#### DSL & Code Generation
- [x] إنشاء DSL Entity (REMaintenanceFund extends MasterFile)
- [x] تعريف الحقول في الـ DSL
- [x] توليد الكود (Generated classes)
- [x] إنشاء Field IDs (IdsOfREMaintenanceFund)
- [x] إنشاء DTO Contracts
- [x] إنشاء Factory
- [x] إنشاء WS Wrapper & WS Impl
- [x] تسجيل الكيان في REEntityTypes
- [x] تسجيل الكيان في REEntities

#### Domain & Business Logic
- [ ] حساب حقل "إجمالي قيمة وديعة الصيانة" - جلب مجموع قيم صيانة الوحدات من عقود البيع
- [ ] حساب حقل "إجمالي المحصل" - جلب القيم المحصلة من أقساط الصيانة
- [ ] حساب حقل "إجمالي مساحة المشروع" - مجموع مساحات الوحدات
- [ ] حساب حقل "الرصيد المتبقي" = إجمالي الوديعة - إجمالي المحصل
- [ ] Validation: التأكد من اختيار المشروع قبل الحفظ
- [ ] ربط البنك والحساب البنكي (فلترة الحسابات حسب البنك المختار)

#### List View (عرض الوحدات)
- [ ] إنشاء List View / Grid يعرض الوحدات المرتبطة بالمشروع
- [ ] عرض عمود الوحدة العقارية
- [ ] عرض عمود قيمة صيانة الوحدة
- [ ] عرض عمود مساحة الوحدة
- [ ] عرض عمود اسم المشتري
- [ ] تحميل بيانات الوحدات تلقائياً عند اختيار المشروع

#### UI & Post Actions
- [ ] إنشاء Default UI للشاشة
- [ ] إضافة الشاشة في القائمة الرئيسية (DefaultMenuCreator)
- [ ] Post Action عند تغيير المشروع (تحديث المساحة والوحدات)
- [ ] Post Action عند تغيير البنك (فلترة الحسابات البنكية)

#### Vue / Frontend
- [ ] توليد JS Constants (GenJSConstantFiles)
- [ ] التأكد من ظهور الشاشة في الـ Vue Frontend

---

## 2. أرباح صندوق وديعة الصيانة (REMaintenanceDepositProfit)

### الوصف
مستند (Document) لتسجيل الأرباح المتحققة من صندوق وديعة الصيانة (مثل أرباح الودائع البنكية). عند الحفظ يتم إنشاء قيد محاسبي بقيمة الأرباح.

### الحقول المطلوبة

| #   | الحقل               | Field ID                 | النوع                  | الوصف                                 |
| --- | ------------------- | ------------------------ | ---------------------- | ------------------------------------- |
| 1   | الدفتر              | journal                  | FK → Journal           | دفتر القيود (موجود من DocumentFile)   |
| 2   | التوجيه             | prefix                   | FK → Prefix            | توجيه المستند (موجود من DocumentFile) |
| 3   | التاريخ             | date                     | Date                   | تاريخ المستند (موجود من DocumentFile) |
| 4   | صندوق وديعة الصيانة | maintenanceFund          | FK → REMaintenanceFund | الصندوق المرتبط                       |
| 5   | قيمة أرباح الوديعة  | maintenanceDepositProfit | Decimal                | قيمة الأرباح المحققة                  |

### ملاحظات البيزنس
- عند حفظ/ترحيل المستند يتم إنشاء **قيد محاسبي** بقيمة الأرباح
- القيد المحاسبي: مدين → الحساب البنكي / دائن → حساب أرباح الوديعة (أو حسب الإعداد)

---

### Checklist - أرباح صندوق وديعة الصيانة

#### DSL & Code Generation
- [x] إنشاء DSL Entity (REMaintenanceDepositProfit extends DocumentFile)
- [x] تعريف الحقول في الـ DSL
- [x] توليد الكود (Generated classes)
- [x] إنشاء Field IDs (IdsOfREMaintenanceDepositProfit)
- [x] إنشاء DTO Contracts
- [x] إنشاء Factory
- [x] إنشاء WS Wrapper & WS Impl
- [x] تسجيل الكيان في REEntityTypes
- [x] تسجيل الكيان في REEntities

#### Domain & Business Logic
- [ ] تنفيذ واجهة `IGeneratesAccountingRequest` لإنشاء القيد المحاسبي
- [ ] إضافة حقل `ledgerTransReqId` في الـ DSL
- [ ] تحديد حسابات القيد المحاسبي (مدين/دائن)
- [ ] إنشاء القيد المحاسبي عند الترحيل باستخدام `LedgerTransReqCreator`
- [ ] Validation: التأكد من اختيار الصندوق وإدخال قيمة أرباح
- [ ] تسجيل الكيان في `EntitiesWithLedgerEffectsOrWithParents`

#### UI & Post Actions
- [ ] إنشاء Default UI للشاشة
- [ ] إضافة الشاشة في القائمة الرئيسية (DefaultMenuCreator)

#### Vue / Frontend
- [ ] توليد JS Constants (GenJSConstantFiles)
- [ ] التأكد من ظهور الشاشة في الـ Vue Frontend

---

## 3. إثبات استحقاق الصيانة (REMaintenanceAccrual)

### الوصف
مستند (Document) لإثبات استحقاق تكلفة الصيانة على الوحدات. يعمل بنظامين مختلفين حسب "أساس الإثبات":
- **صيانة السنة**: حساب تكلفة الصيانة السنوية وتوزيعها على الوحدات حسب المساحة
- **فروقات صيانة مدينة / دائنة**: حساب الفرق بين المصروف الفعلي والمحصل

### الحقول المطلوبة - Header

| # | الحقل | Field ID | النوع | الوصف | ملاحظات |
|---|--------|----------|-------|-------|---------|
| 1 | الدفتر | journal | FK → Journal | دفتر القيود | من DocumentFile |
| 2 | التوجيه | prefix | FK → Prefix | توجيه المستند | من DocumentFile |
| 3 | التاريخ | date | Date | تاريخ المستند | من DocumentFile |
| 4 | صندوق وديعة الصيانة | maintenanceFund | FK → REMaintenanceFund | الصندوق المرتبط | |
| 5 | أساس الإثبات | accrualBasis | Enum (REMaintenanceAccrualBasis) | نوع الاستحقاق | Drop Down List |
| 6 | قيمة الصيانة السنوية للمشروع | annualMaintenanceValue | Decimal | تكلفة الصيانة السنوية | يظهر فقط مع "صيانة السنة" |
| 7 | إجمالي مساحة المشروع | totalProjectArea | Decimal | مجموع مساحات الوحدات | يظهر فقط مع "صيانة السنة" |
| 8 | أساس تكلفة الصيانة | maintenanceCostBasis | Decimal | = قيمة الصيانة ÷ إجمالي المساحة | محسوب، يظهر فقط مع "صيانة السنة" |
| 9 | قيمة الصيانة المصروفة للسنة السابقة | previousYearSpentMaintenance | Decimal | المصروف الفعلي للسنة الماضية | يظهر فقط مع الفروقات |
| 10 | قيمة الصيانات المحصلة | collectedMaintenanceValue | Decimal | المبالغ المحصلة من الملاك | يظهر فقط مع الفروقات |
| 11 | فروق الصيانة | maintenanceDifference | Decimal | = المصروف - المحصل | محسوب، يظهر فقط مع الفروقات |

### قواعد إظهار/إخفاء الحقول

| أساس الإثبات | الحقول المفعّلة | الحقول المغلقة |
|--------------|----------------|---------------|
| **صيانة السنة** | قيمة الصيانة السنوية، إجمالي مساحة المشروع، أساس تكلفة الصيانة | قيمة الصيانة المصروفة، قيمة المحصلة، فروق الصيانة |
| **فروقات صيانة مدينة** | قيمة الصيانة المصروفة، قيمة المحصلة، فروق الصيانة | قيمة الصيانة السنوية، إجمالي مساحة المشروع، أساس تكلفة الصيانة |
| **فروقات صيانة دائنة** | قيمة الصيانة المصروفة، قيمة المحصلة، فروق الصيانة | قيمة الصيانة السنوية، إجمالي مساحة المشروع، أساس تكلفة الصيانة |

### الحقول المطلوبة - Detail Grid (جدول الوحدات)

| # | العمود | Field ID | النوع | الوصف |
|---|--------|----------|-------|-------|
| 1 | الوحدة | rentalUnit | FK → RERentalUnit | الوحدة العقارية (الخاضعة للصيانة فقط) |
| 2 | مساحة الوحدة | unitArea | Decimal | مساحة الوحدة |
| 3 | قيمة صيانة الوحدة | unitMaintenanceValue | Decimal | محسوب حسب أساس الإثبات (انظر أدناه) |
| 4 | المشتري أو المؤجر | buyerOrTenant | FK → REOwner | المسؤول عن الصيانة |

### حساب قيمة صيانة الوحدة في الـ Detail

| أساس الإثبات | طريقة الحساب |
|--------------|-------------|
| **صيانة السنة** | مساحة الوحدة × أساس تكلفة الصيانة (maintenanceCostBasis) |
| **فروقات صيانة مدينة** | مساحة الوحدة × فروق الصيانة (maintenanceDifference) |
| **فروقات صيانة دائنة** | مساحة الوحدة × فروق الصيانة (maintenanceDifference) |

### ملاحظات البيزنس
- الجريد يعرض فقط الوحدات المرتبطة بالصندوق والتي عليها علامة "تخضع للصيانة" (subjectToMaintenance = true)
- يجب تحميل الوحدات تلقائياً عند اختيار الصندوق
- حقل "أساس تكلفة الصيانة" = قيمة الصيانة السنوية ÷ إجمالي مساحة المشروع
- حقل "فروق الصيانة" = قيمة الصيانة المصروفة - قيمة الصيانات المحصلة
- يتم إنشاء قيد محاسبي عند الترحيل

### Enum: أساس الإثبات (REMaintenanceAccrualBasis)

| القيمة | الاسم بالعربي | الاسم بالإنجليزي |
|--------|--------------|-----------------|
| YearMaintenance | صيانة السنة | Year Maintenance |
| DebitMaintenanceDifference | فروقات صيانة مدينة | Debit Maintenance Difference |
| CreditMaintenanceDifference | فروقات صيانة دائنة | Credit Maintenance Difference |

---

### Checklist - إثبات استحقاق الصيانة

#### DSL & Code Generation
- [x] إنشاء DSL Entity (REMaintenanceAccrual extends DocumentFile)
- [x] إنشاء DSL Detail Line (REMaintenanceAccrualLine)
- [x] إنشاء Enum (REMaintenanceAccrualBasis)
- [x] تعريف الحقول في الـ DSL (Header + Detail)
- [x] توليد الكود (Generated classes)
- [x] إنشاء Field IDs (IdsOfREMaintenanceAccrual)
- [x] إنشاء DTO Contracts (Header + Detail)
- [x] إنشاء Factory (Entity + Detail Line)
- [x] إنشاء WS Wrapper & WS Impl
- [x] تسجيل الكيان في REEntityTypes
- [x] تسجيل الكيان في REEntities

#### Domain & Business Logic
- [ ] حساب "أساس تكلفة الصيانة" = قيمة الصيانة السنوية ÷ إجمالي مساحة المشروع
- [ ] حساب "فروق الصيانة" = المصروف - المحصل
- [ ] حساب "قيمة صيانة الوحدة" في الـ Detail Lines حسب أساس الإثبات
- [ ] تحميل الوحدات الخاضعة للصيانة تلقائياً من الصندوق المختار
- [ ] Validation: التأكد من وجود وحدات في الجريد
- [ ] Validation: التأكد من اختيار أساس الإثبات
- [ ] تنفيذ واجهة `IGeneratesAccountingRequest` لإنشاء القيد المحاسبي
- [ ] إضافة حقل `ledgerTransReqId` في الـ DSL
- [ ] تسجيل الكيان في `EntitiesWithLedgerEffectsOrWithParents`

#### UI & Post Actions
- [ ] إنشاء Default UI للشاشة
- [ ] إضافة الشاشة في القائمة الرئيسية (DefaultMenuCreator)
- [ ] Post Action عند تغيير "أساس الإثبات" - تفعيل/إغلاق الحقول المناسبة
- [ ] Post Action عند تغيير "أساس الإثبات" - إعادة حساب قيم صيانة الوحدات في الجريد
- [ ] Post Action عند تغيير "قيمة الصيانة السنوية" - إعادة حساب أساس التكلفة وقيم الوحدات
- [ ] Post Action عند تغيير "إجمالي مساحة المشروع" - إعادة حساب أساس التكلفة وقيم الوحدات
- [ ] Post Action عند تغيير "قيمة الصيانة المصروفة" أو "المحصلة" - إعادة حساب الفروق وقيم الوحدات
- [ ] Post Action عند اختيار الصندوق - تحميل الوحدات الخاضعة للصيانة في الجريد
- [ ] تحميل مساحة الوحدة تلقائياً عند إضافتها في الجريد
- [ ] تحميل اسم المشتري/المؤجر تلقائياً

#### Vue / Frontend
- [ ] توليد JS Constants (GenJSConstantFiles)
- [ ] التأكد من ظهور الشاشة في الـ Vue Frontend

---

## 4. تعديل الوحدة العقارية (RERentalUnit)

### الوصف
إضافة حقل checkbox جديد على الوحدة العقارية يحدد إذا كانت الوحدة تخضع للصيانة أم لا.

### الحقول الجديدة

| # | الحقل | Field ID | النوع | الوصف |
|---|--------|----------|-------|-------|
| 1 | صندوق الصيانة | maintenanceFund | FK → REMaintenanceFund | ربط الوحدة بصندوق صيانة |
| 2 | تخضع للصيانة | subjectToMaintenance | Boolean (Checkbox) | هل هذه الوحدة خاضعة لمنظومة الصيانة |

---

### Checklist - تعديل الوحدة العقارية

- [x] إضافة حقل `maintenanceFund` في DSL
- [x] إضافة حقل `subjectToMaintenance` في DSL
- [x] إعادة توليد الكود
- [x] تحديث Field IDs
- [ ] إضافة الحقول في Default UI للوحدة العقارية
- [ ] توليد JS Constants (GenJSConstantFiles)

---

## ملخص الحالة الحالية

### ما تم إنجازه (الهيكل الأساسي)
- جميع ملفات الـ DSL مكتملة للكيانات الثلاثة ✅
- الكود المولّد (Generated) مكتمل لكل الكيانات ✅
- الـ DTOs و Factories و WS Wrappers مولّدة ✅
- الكيانات مسجلة في REEntityTypes و REEntities ✅
- حقول الوحدة العقارية الجديدة مضافة ✅

### ما يحتاج تنفيذ (Business Logic & UI)

| المهمة | الأولوية | التعقيد |
|--------|---------|---------|
| Business Logic لصندوق الصيانة (حساب الإجماليات) | عالية | متوسط |
| List View الوحدات في صندوق الصيانة | عالية | متوسط |
| القيد المحاسبي لأرباح الوديعة | عالية | متوسط |
| منطق تفعيل/إغلاق الحقول في إثبات الاستحقاق | عالية | عالي |
| حسابات الاستحقاق (أساس التكلفة، الفروق، قيم الوحدات) | عالية | عالي |
| تحميل الوحدات تلقائياً في جريد الاستحقاق | عالية | متوسط |
| القيد المحاسبي لإثبات الاستحقاق | عالية | متوسط |
| Default UI للشاشات الثلاثة | عالية | منخفض |
| إضافة الشاشات في القائمة الرئيسية | عالية | منخفض |
| Post Actions (جميعها) | عالية | عالي |
| إضافة `ledgerTransReqId` للمستندين | عالية | منخفض |
| Vue JS Constants | متوسطة | منخفض |
